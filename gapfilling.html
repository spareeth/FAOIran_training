<!DOCTYPE html>

<html lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>Gap filling using temporal and spatial interpolation</title>
  <meta name="description" content="Exercise on raster time series">
  <meta name="author" content="Sajid Pareeth">
  <link rel="shortcut icon" href="grass.png">

  <script type="text/javascript" src="lib/jquery.js"></script>
  <script type="text/javascript" src="lib/codetabs.js"></script>
  <script type="text/javascript" src="lib/highlights/highlight.pack.js"></script>
  <link rel="stylesheet" href="lib/highlights/styles/default.css">
  <link rel="stylesheet" href="css/grassdocs.css">
  <link rel="stylesheet" href="css/codetabs.css">

<style type="text/css">
.hljs{
    display: none;
    /*padding: 0em;*/
}
</style>

</head>
<body>
  <div id="container">
	<h1>Gap-filling Actual Evapotranspiration maps</h1>
     <p style="text-align:center">
	
    <h2><a name="Guidedtour">Basic overview of this session</a></h2>
    <p>
	In this session, we will process all the ETa and Biomass outputs obtained from PySEBAL for a year and got through steps to gap fill them. We will compute gap-filled monthly ETa maps followed by seasonal and annual maps. We will gap-fill ETa in this tutorial, and Biomass you can try it yourself following this manual.
    <p>
	
	<h4>Data</h4>
    For this exercise, data is provided as Geotiff files in USB sticks. Copy them to your computer and note the path.

<h3><a name="Create">Create new mapset</a></h3>
    <p>First we will create a mapset to do this exercise. As we are working in NLBC area, we can use the same <b>location</b> corresponding to the Coordinate Reference System (CRS) -  UTM43N (EPSG:32643)</p>
   <pre>
<!--         <code class="neutral">
cd /d/ecad5_geotiffs_LL
r.in.gdal input=elev_0.25deg_reg_v6.0.tif output=elev_ecad
r.colors map=elev_ecad color=elevation
        </code> -->
        <code class="neutral">
# Creating a new mapset called "gapfilling"
grass78 /mnt/d/grassdata/utm43n/gapfilling -c
# Add the previous mapset to search path 
# so that you can access the Land use map imported yesterday
g.mapsets mapset=nlbc operation=add
# Set the region
g.region vect=nlbc res=30 -a
        </code>
    </pre>
    
<h3><a name="Import">Import data into newly created mapset</a></h3>   
<pre><code class="neutral">
# change directory (cd) to the folder with downloaded Geotiff files
cd /mnt/d/ADB_day3/Data/ETa_maps
# For loop to import all the tif files at once.
for i in `ls *.tif`; do
    out=`echo $i|cut -d. -f1`
    r.import in=$i out=$out
done
# Test if all data has been imported
g.list rast map=.|cat
g.list rast map=. pattern=L8_ETact*|cat
# How many maps are there
g.list rast map=. pattern=L8_ETact*|wc -l
# How many ETa maps for the month of January
g.list rast map=. pattern=L8_ETact*2017_01*|wc -l
</code></pre>

<h3><a name="aggregate1">Monthly aggregate by averaging</a></h3>   
<pre><code class="neutral">
# For loop to average maps in each month mm/day
y=2017
for i in `seq -w 1 12`; do
    r.series input=`g.list rast pattern=L8_ETact_24_30m_${y}_${mm}_* sep=,` output=ETa_SEBAL_${y}_${i}_mm_day method=average
done
</code></pre>

<h3><a name="aggregate2">Monthly mm/day to mm/month</a></h3>  
Here we multiply the average ETa in <i>mm/day</i> per month to number of days per month to get ETa in <i>mm/month</i>. For this step you need an additional script called <code>month2day</code> which you can download from here: 
<pre><code class="neutral">
# For loop to multiply monthly ETa with number of days per month.
y=2017
for i in `seq -w 1 12`; do
    n=`month2day ${i} ${i}|wc -l`
    echo "${i} has ${n} days";
    r.mapcalc "ETa_SEBAL_${y}_${i}_mm_month = ETa_SEBAL_${y}_${i}_mm_day * ${n}" --o ;
done
</code></pre>

<h3><a name="temporal1">Temporal interpolation using LWR</a></h3>  
GRASS offers LWR as an extension (Addon). Comprehensive list f addons are provided here.

<pre><code class="neutral">
# GRASS offers LWR as an extension
# Install the extension first.
g.extension extension=r.series.lwr
# Create a text file with names of the maps to gap fill
g.list rast map=. pattern=ETa*mm_month > names_ETa.txt
cat names_ETa.txt
r.series.lwr -l -h -i file=names_ETa.txt suffix=_lwr order=2 weight=tricube range=0,inf fet=0.5 dod=3 maxgap=3 --o
g.list rast map=. pattern=*_lwr
</code></pre>

<h3><a name="temporal2">Temporal interpolation using HANTS (optional)</a></h3>  
GRASS offers HArmonic Analysis of Time Series (HANTS) as an extension (Addon). Comprehensive list f addons are provided here.

<pre><code class="neutral">
# GRASS offers LWR as an extension
# Install the extension first.
g.extension extension=r.hants
# Create a text file with names of the maps to gap fill
g.list rast map=. pattern=ETa*mm_month > names_ETa.txt
cat names_ETa.txt
r.hants file=names_ETa.txt suffix=_hants nf=3 range=0,inf fet=0.5 dod=3 --o
# Test the outputs
g.list rast map=. pattern=*_hants
</code></pre>

<h3><a name="patching">Patching the original observations</a></h3>  
Temporal interpolations smoothen the entire pixels. Some times you want to retain the actual observations, then do this step. Let us do it for LWR outputs. You can try for HANTS outputs yourself.

<pre><code class="neutral">
y=2017
for i in `seq -w 1 12`; do 
    r.patch in=ETa_SEBAL_${y}_${i}_mm_month,ETa_SEBAL_${y}_${i}_mm_month_lwr out=ETa_SEBAL_${y}_${i}_mm_month_lwr_patch --o
done
</code></pre>

<h3><a name="Spatial">Spatial interpolation</a></h3>  
Now let us fill the remaining gaps using a spatial interpolation only on gaps.
<pre><code class="neutral">
for i in `g.list rast pattern=ETa*patch map=.`; do 
    r.fillnulls input=${i} output=${i}_fillnull method=bilinear npmin=600 segmax=300 --o
done
# List the outputs
g.list rast map=. pattern=*patch_fillnull
</code></pre>

<h3><a name="filter">Outlier filtering</a></h3>  
Here all the values less than zero is set to zero and any value above 99 percentile is set to 99 perentile.

<pre><code class="neutral">
# Set all values less than zero to zero
for i in `g.list rast pattern=ETa*patch_fillnull$ map=.`; do 
    r.mapcalc "${i}_filt = if(${i} < 0, 0, ${i})" --o
done
# Set all values greater than 99 percentile to 99 percentile
for i in `g.list rast pattern=ETa*patch_fillnull_filt$ map=.`; do
    eval `r.univar ${i} percentile=99 -e -g`
    r.mapcalc "${i} = if(${i} >= $percentile_99, $percentile_99, ${i})" --o
    unset percentile_99
done
# List the outputs
g.list rast map=. pattern=*patch_fillnull_filt
</code></pre>

<h3><a name="Aggregation">Aggregate the gap-filled maps to seasonal</a></h3>  

<pre><code class="neutral">
# Set all values less than zero to zero
r.series input=ETa_SEBAL_2017_09_mm_month_lwr_patch_fillnull_filt,ETa_SEBAL_2017_10_mm_month_lwr_patch_fillnull_filt,ETa_SEBAL_2017_11_mm_month_lwr_patch_fillnull_filt,ETa_SEBAL_2017_12_mm_month_lwr_patch_fillnull_filt out=ETa_kharif_season_2017 method=sum --o
done
</code></pre>

<b> REPEAT THE PREVIOUS STEPS FOR BIOMASS MAPS AND CREATE SEASONAL BIOMASS MAP. Then proceed to next step</b>

<h3><a name="WP">Seasonal Biomass Water Productivity</a></h3>  

<pre><code class="neutral">
# WP in Kg/m3
r.mapcalc "BIO_WP_Kharif_season_2017 = BIO_kharif_season_2017/(ETa_kharif_season_2017 * 10)" --o
</code></pre>

<h3><a name="visualdata">Visualize data</a></h3>	
   <p>
	Let us now display the elevation map and add decorations.
	</p>
  <pre>
p
</pre>	

<h3><a name="Export">Export data from GRASS GIS</a></h3>  
You can either use grass7 plugin in QGIS to directly visualize the maps in QGIS or export the raster maps to other formats.
<pre><code class="neutral">
# Export the seasonal ETa to Geotiff
r.out.gdal in=ETa_kharif_season_2017 out=ETa_kharif_season_2017.tif
</code></pre>

<h3><a name="Temporal">Temporal data base for monthly ETa</a></h3>  
Explore the temporal DB functionality in GRASS
<pre><code class="neutral">
# Before gap-filling
# Create monthly ETa temporal DB
t.create type=strds temporaltype=absolute output=Eta_monthly_before title="Monthly ETa 30m year 2017" description="Monthly ETa 30m year 2017 before gapfilling"
# Create a text file with list of map names
g.list -m rast map=. pattern=ETa*mm_month$ > names_eta_before.txt
# Register the maps to the created Temporal DB
t.register -i input=Eta_monthly_before file=names_eta_before.txt start="2017-01-01" increment="1 months" --o

# After gap-filling
# Create monthly ETa temporal DB
t.create type=strds temporaltype=absolute output=Eta_monthly_after title="Monthly ETa 30m year 2017" description="Monthly ETa 30m year 2017 after gap filling"
# Create a text file with list of map names
g.list -m rast map=. pattern=ETa*mm_month_lwr_patch_fillnull_filt > names_eta_after.txt
# Register the maps to the created Temporal DB
t.register -i input=Eta_monthly_after file=names_eta_after.txt start="2017-01-01" increment="1 months" --o
# list the temporal datasets
t.list
# Get info of one temporal datasets
t.info Eta_monthly_after
# List the raster maps in one temporal datasets
t.rast.list Eta_monthly_after columns=name,start_time,min,max
# List the univariate stats of temporal datasets
t.rast.univar Eta_monthly_after separator=comma output=stats_Eta_monthly_after.csv
</code></pre>

Try <code>g.gui.tplot</code> and <code>g.gui.timeline</code> to visualize time series data.


    <p style="border-top-style: solid; border-width: 5px; border-color: rgb(130, 130, 130); padding-top: 5px;" align="center">
    <h2>Other (very) useful links</h2>
    <ul>
        <li>GRASS GIS wiki: <a href="https://grasswiki.osgeo.org/wiki/GRASS-Wiki" target="_blank">https://grasswiki.osgeo.org/wiki/GRASS-Wiki</a></li>
        <li>GRASS GIS and R for time series processing: <a href="https://grasswiki.osgeo.org/wiki/Temporal_data_processing/GRASS_R_raster_time_series_processing" target="_blank">https://grasswiki.osgeo.org/wiki/Temporal_data_processing/GRASS_R_raster_time_series_processing</a></li>
    </ul>
    <h2>References</h2>
    <ul>
        <li>Related books: <a href="https://grass.osgeo.org/documentation/books/" target="_blank">https://grass.osgeo.org/documentation/books/</a></li>
        <li>Related tutorials and articles: <a href="https://grass.osgeo.org/documentation/tutorials/" target="_blank">https://grass.osgeo.org/documentation/tutorials/</a></li>
    </ul>
    </p>
    <hr>

    <a href="http://grass.osgeo.org/grass72/manuals/">GRASS GIS manual main index</a> |
    <a href="http://grass.osgeo.org/grass72/manuals/topics.html">Topics index</a> |
    <a href="http://grass.osgeo.org/grass72/manuals/keywords.html">Keywords Index</a> |
    <a href="http://grass.osgeo.org/grass72/manuals/full_index.html">Full index</a> | 
    <a href="http://grass.osgeo.org/grass72/manuals/raster.html">Raster index</a> | 
    <a href="http://grass.osgeo.org/grass72/manuals/vector.html">Vector index</a> |
    <a href="http://grass.osgeo.org/grass72/manuals/temporal.html">Temporal index</a> |
    </p>
    <p>
    <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" src="images/ccbysa.png"></a>

</body>
</html>
